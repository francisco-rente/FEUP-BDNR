[{"appcode":"function OnUpdate(doc, meta) {\n    log(\"Doc created/updated\", meta.id);\n    if(doc.reviews.length == 0) return;\n    try {\n        var id = meta.id; \n        var avg_rating = N1QL(\n            \"SELECT AVG(r.star_rating) AS rating \" +\n            \"FROM server.store.products AS p \" +\n            \"UNNEST p.reviews AS r \" + \n            \"WHERE p.product_id = $1\", \n            [id],\n            { 'isPrepared': true }\n        );\n        \n        for (var res of avg_rating){\n            doc[\"avg_rating\"] = res[\"rating\"];\n            break;\n        }\n        \n        products[id] = doc;\n    } catch(e) {\n        log(\"OnUpdate err\", e); \n        return e;\n    }\n}\n\nfunction OnDelete(meta, options) {\n    log(\"Doc deleted/expired\", meta.id);\n}\n\n","depcfg":{"buckets":[{"alias":"users","bucket_name":"server","scope_name":"store","collection_name":"users","access":"rw"},{"alias":"products","bucket_name":"server","scope_name":"store","collection_name":"products","access":"rw"},{"alias":"stores","bucket_name":"server","scope_name":"store","collection_name":"stores","access":"rw"}],"source_bucket":"server","source_scope":"store","source_collection":"products","metadata_bucket":"eventing_bucket","metadata_scope":"_default","metadata_collection":"_default"},"version":"evt-7.1.4-3601-ee","enforce_schema":false,"handleruuid":1296157275,"function_instance_id":"uqAsu1","appname":"reviews_eventing","settings":{"dcp_stream_boundary":"everything","deployment_status":false,"description":"Generate events for the reviews collection","execution_timeout":60,"language_compatibility":"6.6.2","log_level":"INFO","n1ql_consistency":"none","num_timer_partitions":128,"processing_status":false,"timer_context_size":1024,"user_prefix":"eventing","worker_count":1},"function_scope":{"bucket":"*","scope":"*"}}]